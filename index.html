<!DOCTYPE html>
<html lang='fr'>
<head>
<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0'>
<title>Appel des groupes</title>
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css'>
<style>
  body { padding: 20px; }
  .child-item { margin-bottom: 10px; }
  .dark-mode { background-color: #121212; color: #ffffff; }
</style>
</head>
<body>
<div class='container'>
  <h1 class='mb-4'>Appel des groupes</h1>

  <!-- Authentification simple -->
  <div id='auth-section'>
    <input type='password' id='password' class='form-control mb-2' placeholder='Mot de passe'>
    <button class='btn btn-primary' onclick='authenticate()'>Entrer</button>
  </div>

  <div id='app-section' style='display:none;'>
    <button class='btn btn-secondary mb-3' onclick='toggleDarkMode()'>Mode sombre/clair</button>

    <!-- Groupe Louveteaux-Louvettes -->
    <h2>Louveteaux-Louvettes</h2>
    <input type='text' id='new-child-louv' class='form-control mb-2' placeholder="Nom">
    <button class='btn btn-primary mb-3' onclick='addChild("louv")'>Ajouter</button>
    <div id='children-list-louv' class='mb-3'></div>
    <button class='btn btn-success' onclick='validateAttendance("louv")'>Valider l'appel</button>
    <button class='btn btn-secondary ms-2' onclick='exportCSV("louv")'>Exporter CSV</button>

    <!-- Groupe Éclaireurs-Éclaireuses -->
    <h2 class='mt-4'>Éclaireurs-Éclaireuses</h2>
    <input type='text' id='new-child-ecl' class='form-control mb-2' placeholder="Nom">
    <button class='btn btn-primary mb-3' onclick='addChild("ecl")'>Ajouter</button>
    <div id='children-list-ecl' class='mb-3'></div>
    <button class='btn btn-success' onclick='validateAttendance("ecl")'>Valider l'appel</button>
    <button class='btn btn-secondary ms-2' onclick='exportCSV("ecl")'>Exporter CSV</button>

    <!-- Historique -->
    <h3 class='mt-4'>Historique des appels</h3>
    <input type='date' id='filter-date' class='form-control mb-2' onchange='filterHistory()'>
    <div id='history'></div>
  </div>
</div>

<script>
let password = 'scout2025';
let children = {
  louv: JSON.parse(localStorage.getItem('children_louv')) || ["Alice", "Bob"],
  ecl: JSON.parse(localStorage.getItem('children_ecl')) || ["Charlie", "Diane"]
};
let history = JSON.parse(localStorage.getItem('history')) || [];

function authenticate() {
  const input = document.getElementById('password').value;
  if (input === password) {
    document.getElementById('auth-section').style.display = 'none';
    document.getElementById('app-section').style.display = 'block';
    renderLists();
    renderHistory();
  } else {
    alert('Mot de passe incorrect');
  }
}

function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
}

function renderLists() {
  renderList('louv');
  renderList('ecl');
}

function renderList(group) {
  const container = document.getElementById(`children-list-${group}`);
  container.innerHTML = '';
  children[group].forEach((child, index) => {
    container.innerHTML += `
      <div class='child-item'>
        <input type='checkbox' id='${group}-${index}'>
        <label for='${group}-${index}'>${child}</label>
        <button class='btn btn-sm btn-danger ms-2' onclick='removeChild("${group}", ${index})'>Supprimer</button>
      </div>`;
  });
}

function addChild(group) {
  const input = document.getElementById(`new-child-${group}`);
  const name = input.value.trim();
  if (name) {
    children[group].push(name);
    localStorage.setItem(`children_${group}`, JSON.stringify(children[group]));
    input.value = '';
    renderList(group);
  }
}

function removeChild(group, index) {
  children[group].splice(index, 1);
  localStorage.setItem(`children_${group}`, JSON.stringify(children[group]));
  renderList(group);
}

function validateAttendance(group) {
  const date = new Date().toLocaleDateString();
  let result = [];
  children[group].forEach((child, index) => {
    const present = document.getElementById(`${group}-${index}`).checked;
    result.push({ name: child, status: present ? 'Présent' : 'Absent', group });
  });
  history.push({ date, result });
  localStorage.setItem('history', JSON.stringify(history));
  alert(`Appel enregistré pour ${group}`);
  renderHistory();
}

function renderHistory(filteredDate = null) {
  const container = document.getElementById('history');
  container.innerHTML = '';
  history.forEach(entry => {
    if (!filteredDate || entry.date === filteredDate) {
      let html = `<strong>${entry.date}</strong><ul>`;
      entry.result.forEach(r => {
        html += `<li>[${r.group}] ${r.name} : ${r.status}</li>`;
      });
      html += '</ul>';
      container.innerHTML += html;
    }
  });
}

function filterHistory() {
  const date = document.getElementById('filter-date').value;
  renderHistory(date);
}

function exportCSV(group) {
  let csvContent = "Date,Groupe,Nom,Statut
";
  history.forEach(entry => {
    entry.result.filter(r => r.group === group).forEach(r => {
      csvContent += `${entry.date},${r.group},${r.name},${r.status}
`;
    });
  });
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `historique_${group}.csv`;
  link.click();
}
</script>
</body>
</html>
